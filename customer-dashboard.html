<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Dashboard | Trace Veil Forensics</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #0A1628; --secondary: #1E3A5F; --accent: #FFD700; --sidebar-width: 260px; }
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background: #f0f2f5; min-height: 100vh; }
        .dashboard-layout { display: flex; }
        .sidebar { width: var(--sidebar-width); background: linear-gradient(180deg, var(--primary) 0%, #0d1a33 100%); color: white; min-height: 100vh; position: fixed; left: 0; top: 0; overflow-y: auto; z-index: 1000; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .sidebar-header { padding: 25px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center; background: rgba(0,0,0,0.2); }
        .sidebar-header img { max-width: 160px; margin-bottom: 5px; }
        .sidebar-header a { color: rgba(255,255,255,0.7); text-decoration: none; font-size: 13px; display: block; margin-top: 10px; transition: color 0.2s; }
        .sidebar-header a:hover { color: var(--accent); }
        .sidebar-nav { padding: 15px 0; }
        .nav-section { margin-bottom: 10px; }
        .nav-section-title { padding: 10px 20px 5px; font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: rgba(255,255,255,0.4); font-weight: 600; }
        .nav-item { display: flex; align-items: center; padding: 12px 20px; color: rgba(255,255,255,0.8); text-decoration: none; transition: all 0.2s; cursor: pointer; border-left: 3px solid transparent; margin: 2px 10px; border-radius: 6px; }
        .nav-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-item.active { background: rgba(255,215,0,0.15); color: var(--accent); border-left-color: var(--accent); }
        .nav-item i { width: 22px; margin-right: 10px; font-size: 16px; text-align: center; }
        .main-content { margin-left: var(--sidebar-width); flex: 1; padding: 30px; background: #f0f2f5; min-height: 100vh; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: white; padding: 20px 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .page-title { font-size: 24px; font-weight: 700; color: var(--primary); margin: 0; }
        .page-title i { color: var(--accent); margin-right: 10px; }
        .welcome-text { color: #888; font-size: 14px; margin-top: 5px; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 40px; height: 40px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); font-weight: 700; font-size: 14px; }
        .user-name { font-weight: 600; color: var(--primary); font-size: 14px; }
        .btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .btn-primary { background: var(--accent); color: var(--primary); }
        .btn-primary:hover { background: #e6c200; transform: translateY(-1px); }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-secondary:hover { background: #2a4a7f; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 4px solid var(--accent); transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; margin-bottom: 15px; }
        .stat-icon.blue { background: linear-gradient(135deg, #1E3A5F 0%, #2a4a7f 100%); color: white; }
        .stat-icon.green { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); color: white; }
        .stat-icon.yellow { background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%); color: white; }
        .stat-icon.red { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; }
        .stat-icon.purple { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); color: white; }
        .stat-value { font-size: 26px; font-weight: 700; color: var(--primary); margin-bottom: 5px; }
        .stat-label { font-size: 13px; color: #888; font-weight: 500; }
        .card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 25px; overflow: hidden; }
        .card-header { padding: 20px 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fafafa; }
        .card-title { font-size: 16px; font-weight: 600; color: var(--primary); margin: 0; display: flex; align-items: center; gap: 10px; }
        .card-title i { color: var(--accent); }
        .card-body { padding: 20px 25px; }
        .table { width: 100%; border-collapse: collapse; }
        .table th { padding: 14px 15px; text-align: left; border-bottom: 2px solid #eee; font-weight: 600; color: #666; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; background: #fafafa; }
        .table td { padding: 14px 15px; border-bottom: 1px solid #f0f0f0; color: #333; font-size: 14px; }
        .table tbody tr:hover { background: #f8f9fa; }
        .table tbody tr:last-child td { border-bottom: none; }
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-draft { background: #f0f0f0; color: #666; }
        .status-sent { background: #e3f2fd; color: #1976d2; }
        .status-paid { background: #e8f5e9; color: #388e3c; }
        .status-overdue { background: #ffebee; color: #d32f2f; }
        .status-pending { background: #fff3e0; color: #f57c00; }
        .status-completed { background: #e8f5e9; color: #388e3c; }
        .status-in_progress { background: #e3f2fd; color: #1976d2; }
        .service-card { background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%); border: 2px solid #eee; border-radius: 12px; padding: 25px; margin-bottom: 20px; transition: all 0.2s; }
        .service-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .service-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .service-icon { width: 50px; height: 50px; background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; }
        .service-name { font-size: 18px; font-weight: 600; color: var(--primary); }
        .service-desc { color: #666; font-size: 14px; margin-bottom: 15px; line-height: 1.6; }
        .plans-list { margin-top: 15px; }
        .plan-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: white; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid var(--accent); }
        .plan-info { flex: 1; }
        .plan-name { font-weight: 600; color: var(--primary); font-size: 14px; }
        .plan-desc { font-size: 12px; color: #888; margin-top: 2px; }
        .plan-price { font-weight: 700; color: var(--accent); font-size: 16px; margin-right: 15px; }
        .profile-section { margin-bottom: 30px; }
        .profile-section h3 { font-size: 16px; font-weight: 600; color: var(--primary); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--accent); display: inline-block; }
        .profile-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .profile-item { background: #f8f9fa; padding: 15px; border-radius: 8px; }
        .profile-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; }
        .profile-value { font-size: 14px; font-weight: 500; color: var(--primary); }
        .empty-state { text-align: center; padding: 50px 20px; color: #999; }
        .empty-state i { font-size: 48px; color: #ddd; margin-bottom: 15px; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; border-radius: 16px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-header { padding: 20px 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: var(--primary); color: white; border-radius: 16px 16px 0 0; }
        .modal-title { margin: 0; font-size: 18px; font-weight: 600; }
        .modal-close { background: none; border: none; color: white; font-size: 28px; cursor: pointer; opacity: 0.8; transition: opacity 0.2s; }
        .modal-close:hover { opacity: 1; }
        .modal-body { padding: 25px; }
        .modal-footer { padding: 15px 25px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; background: #fafafa; border-radius: 0 0 16px 16px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: #555; font-size: 13px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; box-sizing: border-box; transition: border-color 0.2s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--accent); }
        .toast { position: fixed; bottom: 30px; right: 30px; background: #27ae60; color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 3000; display: none; }
        .toast.show { display: block; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="toast" class="toast"></div>
    <div id="modalContainer"></div>
    <script>
        let currentUser = null;
        let token = null;

        async function init() {
            token = localStorage.getItem('token');
            const userStr = localStorage.getItem('user');
            if (!token || !userStr) { window.location.href = 'login.html'; return; }
            try {
                currentUser = JSON.parse(userStr);
                showDashboard();
            } catch(e) { window.location.href = 'login.html'; }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function showDashboard() {
            document.getElementById('app').innerHTML = `
                <div class="dashboard-layout">
                    <aside class="sidebar">
                        <div class="sidebar-header">
                            <img src="LOGO_NAME_optimized.png" alt="Trace Veil Forensics">
                            <a href="index.html"><i class="fas fa-home"></i> Back to Website</a>
                        </div>
                        <nav class="sidebar-nav">
                            <div class="nav-section">
                                <div class="nav-section-title">Dashboard</div>
                                <a href="#" class="nav-item active" onclick="showPage('overview', this)"><i class="fas fa-tachometer-alt"></i> Overview</a>
                                <a href="#" class="nav-item" onclick="showPage('invoices', this)"><i class="fas fa-file-invoice-dollar"></i> My Invoices</a>
                                <a href="#" class="nav-item" onclick="showPage('requests', this)"><i class="fas fa-clipboard-list"></i> Service Requests</a>
                                <a href="#" class="nav-item" onclick="showPage('services', this)"><i class="fas fa-cogs"></i> Available Services</a>
                            </div>
                            <div class="nav-section">
                                <div class="nav-section-title">Account</div>
                                <a href="#" class="nav-item" onclick="showPage('profile', this)"><i class="fas fa-user"></i> My Profile</a>
                                <a href="#" class="nav-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
                            </div>
                        </nav>
                    </aside>
                    <main class="main-content">
                        <div class="page-header">
                            <div>
                                <h1 class="page-title" id="pageTitle"><i class="fas fa-tachometer-alt"></i> Overview</h1>
                                <p class="welcome-text" id="welcomeText">Welcome back!</p>
                            </div>
                            <div class="user-info">
                                <div>
                                    <div class="user-name">${currentUser.first_name} ${currentUser.last_name}</div>
                                </div>
                                <div class="user-avatar">${currentUser.first_name?.charAt(0)}${currentUser.last_name?.charAt(0)}</div>
                            </div>
                        </div>
                        <div id="content"></div>
                    </main>
                </div>
            `;
            showPage('overview');
        }

        async function showPage(page, navEl) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if (navEl) navEl.classList.add('active');
            
            const titles = { overview: '<i class="fas fa-tachometer-alt"></i> Overview', invoices: '<i class="fas fa-file-invoice-dollar"></i> My Invoices', requests: '<i class="fas fa-clipboard-list"></i> Service Requests', services: '<i class="fas fa-cogs"></i> Available Services', profile: '<i class="fas fa-user"></i> My Profile' };
            document.getElementById('pageTitle').innerHTML = titles[page];
            document.getElementById('content').innerHTML = '<div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Loading...</p></div>';

            try {
                switch(page) {
                    case 'overview': {
                        const [invRes, reqRes] = await Promise.all([
                            fetch('/customer-invoices', { headers: { 'Authorization': 'Bearer ' + token } }),
                            fetch('/customer-requests', { headers: { 'Authorization': 'Bearer ' + token } })
                        ]);
                        const invData = await invRes.json();
                        const reqData = await reqRes.json();
                        const invs = invData.invoices || [];
                        const reqs = reqData.requests || [];
                        
                        document.getElementById('content').innerHTML = `
                            <div class="stats-grid">
                                <div class="stat-card"><div class="stat-icon blue"><i class="fas fa-file-invoice"></i></div><div class="stat-value">${invs.length}</div><div class="stat-label">Total Invoices</div></div>
                                <div class="stat-card"><div class="stat-icon green"><i class="fas fa-check-circle"></i></div><div class="stat-value">${invs.filter(i => i.status === 'paid').length}</div><div class="stat-label">Paid Invoices</div></div>
                                <div class="stat-card"><div class="stat-icon yellow"><i class="fas fa-clock"></i></div><div class="stat-value">${invs.filter(i => i.status === 'sent').length}</div><div class="stat-label">Pending Payment</div></div>
                                <div class="stat-card"><div class="stat-icon purple"><i class="fas fa-clipboard-list"></i></div><div class="stat-value">${reqs.filter(r => r.status === 'pending' || r.status === 'in_progress').length}</div><div class="stat-label">Active Requests</div></div>
                            </div>
                            <div class="card">
                                <div class="card-header"><h3 class="card-title"><i class="fas fa-file-invoice"></i> Recent Invoices</h3></div>
                                <div class="card-body">
                                    <table class="table"><thead><tr><th>Invoice #</th><th>Amount</th><th>Status</th><th>Due Date</th></tr></thead>
                                    <tbody>${invs.slice(0,5).map(inv => `<tr><td><strong>${inv.invoice_number || 'N/A'}</strong></td><td>KES ${parseFloat(inv.total || 0).toLocaleString()}</td><td><span class="status-badge status-${inv.status || 'draft'}">${inv.status || 'draft'}</span></td><td>${inv.due_date ? new Date(inv.due_date).toLocaleDateString() : 'N/A'}</td></tr>`).join('') || '<tr><td colspan="4" style="text-align:center;color:#999;padding:30px;">No invoices yet</td></tr>'}</tbody></table>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header"><h3 class="card-title"><i class="fas fa-clipboard-list"></i> Recent Service Requests</h3></div>
                                <div class="card-body">
                                    <table class="table"><thead><tr><th>Title</th><th>Service</th><th>Status</th><th>Priority</th></tr></thead>
                                    <tbody>${reqs.slice(0,5).map(req => `<tr><td><strong>${req.title}</strong></td><td>${req.service_plans?.services?.name || '-'}</td><td><span class="status-badge status-${req.status}">${req.status}</span></td><td><span class="status-badge status-${req.priority === 'high' || req.priority === 'urgent' ? 'overdue' : 'pending'}">${req.priority}</span></td></tr>`).join('') || '<tr><td colspan="4" style="text-align:center;color:#999;padding:30px;">No service requests yet</td></tr>'}</tbody></table>
                                </div>
                            </div>
                        `;
                        break;
                    }
                    case 'invoices': {
                        const res = await fetch('/customer-invoices', { headers: { 'Authorization': 'Bearer ' + token } });
                        const data = await res.json();
                        document.getElementById('content').innerHTML = `
                            <div class="card">
                                <div class="card-header"><h3 class="card-title"><i class="fas fa-file-invoice-dollar"></i> My Invoices (${(data.invoices || []).length})</h3></div>
                                <div class="card-body">
                                    <table class="table"><thead><tr><th>Invoice #</th><th>Amount</th><th>Status</th><th>Issue Date</th><th>Due Date</th></tr></thead>
                                    <tbody>${(data.invoices || []).map(inv => `<tr><td><strong>${inv.invoice_number || 'N/A'}</strong></td><td>KES ${parseFloat(inv.total || 0).toLocaleString()}</td><td><span class="status-badge status-${inv.status || 'draft'}">${inv.status || 'draft'}</span></td><td>${inv.issue_date ? new Date(inv.issue_date).toLocaleDateString() : 'N/A'}</td><td>${inv.due_date ? new Date(inv.due_date).toLocaleDateString() : 'N/A'}</td></tr>`).join('') || '<tr><td colspan="5" style="text-align:center;color:#999;padding:40px;">No invoices yet</td></tr>'}</tbody></table>
                                </div>
                            </div>
                        `;
                        break;
                    }
                    case 'requests': {
                        const res = await fetch('/customer-requests', { headers: { 'Authorization': 'Bearer ' + token } });
                        const data = await res.json();
                        document.getElementById('content').innerHTML = `
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-clipboard-list"></i> My Service Requests (${(data.requests || []).length})</h3>
                                    <button class="btn btn-primary btn-sm" onclick="showRequestModal()"><i class="fas fa-plus"></i> New Request</button>
                                </div>
                                <div class="card-body">
                                    <table class="table"><thead><tr><th>Title</th><th>Service</th><th>Status</th><th>Priority</th><th>Requested</th></tr></thead>
                                    <tbody>${(data.requests || []).map(req => `<tr><td><strong>${req.title}</strong></td><td>${req.service_plans?.services?.name || '-'}</td><td><span class="status-badge status-${req.status}">${req.status}</span></td><td><span class="status-badge status-${req.priority === 'high' || req.priority === 'urgent' ? 'overdue' : 'pending'}">${req.priority}</span></td><td>${new Date(req.created_at).toLocaleDateString()}</td></tr>`).join('') || '<tr><td colspan="5" style="text-align:center;color:#999;padding:40px;">No service requests yet</td></tr>'}</tbody></table>
                                </div>
                            </div>
                        `;
                        break;
                    }
                    case 'services': {
                        const res = await fetch('/public-services');
                        const data = await res.json();
                        document.getElementById('content').innerHTML = `
                            <div class="card">
                                <div class="card-header"><h3 class="card-title"><i class="fas fa-cogs"></i> Available Services</h3></div>
                                <div class="card-body">
                                    ${(data.services || []).map(s => `
                                        <div class="service-card">
                                            <div class="service-header">
                                                <div class="service-icon"><i class="fas ${s.icon || 'fa-cog'}"></i></div>
                                                <div class="service-name">${s.name}</div>
                                            </div>
                                            <div class="service-desc">${s.description || ''}</div>
                                            ${s.service_plans?.length ? `
                                                <div class="plans-list">
                                                    ${s.service_plans.map(p => `
                                                        <div class="plan-item">
                                                            <div class="plan-info">
                                                                <div class="plan-name">${p.name}</div>
                                                                <div class="plan-desc">${p.description || ''}</div>
                                                            </div>
                                                            <div class="plan-price">KES ${parseFloat(p.price || 0).toLocaleString()}</div>
                                                            <button class="btn btn-primary btn-sm" onclick="quickRequest('${p.id}', '${s.name} - ${p.name}')">Request</button>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('') || '<div class="empty-state"><i class="fas fa-cogs"></i><p>No services available</p></div>'}
                                </div>
                            </div>
                        `;
                        break;
                    }
                    case 'profile': {
                        const res = await fetch('/customer-profile', { headers: { 'Authorization': 'Bearer ' + token } });
                        const data = await res.json();
                        const c = data.customer || {};
                        const u = c.users || {};
                        document.getElementById('content').innerHTML = `
                            <div class="card">
                                <div class="card-header"><h3 class="card-title"><i class="fas fa-user"></i> My Profile</h3></div>
                                <div class="card-body">
                                    <div class="profile-section">
                                        <h3>Personal Information</h3>
                                        <div class="profile-grid">
                                            <div class="profile-item"><div class="profile-label">First Name</div><div class="profile-value">${u.first_name || '-'}</div></div>
                                            <div class="profile-item"><div class="profile-label">Last Name</div><div class="profile-value">${u.last_name || '-'}</div></div>
                                            <div class="profile-item"><div class="profile-label">Email</div><div class="profile-value">${u.email || '-'}</div></div>
                                            <div class="profile-item"><div class="profile-label">Phone</div><div class="profile-value">${u.phone || '-'}</div></div>
                                            <div class="profile-item"><div class="profile-label">Company</div><div class="profile-value">${u.company || '-'}</div></div>
                                        </div>
                                    </div>
                                    <div class="profile-section">
                                        <h3>Billing Information</h3>
                                        <div class="profile-grid">
                                            <div class="profile-item"><div class="profile-label">Company Name</div><div class="profile-value">${c.company_name || '-'}</div></div>
                                            <div class="profile-item"><div class="profile-label">Billing Address</div><div class="profile-value">${c.billing_address || '-'}</div></div>
                                            <div class="profile-item"><div class="profile-label">City</div><div class="profile-value">${c.billing_city || '-'}</div></div>
                                            <div class="profile-item"><div class="profile-label">State</div><div class="profile-value">${c.billing_state || '-'}</div></div>
                                            <div class="profile-item"><div class="profile-label">Postal Code</div><div class="profile-value">${c.billing_postal_code || '-'}</div></div>
                                            <div class="profile-item"><div class="profile-label">Country</div><div class="profile-value">${c.billing_country || '-'}</div></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        break;
                    }
                }
            } catch(e) {
                document.getElementById('content').innerHTML = '<div class="card"><div class="card-body"><p style="color:#e74c3c">Error: ' + e.message + '</p></div></div>';
            }
        }

        async function showRequestModal(servicePlanId = '') {
            const svcRes = await fetch('/public-services');
            const svcData = await svcRes.json();
            
            const modal = document.getElementById('modalContainer');
            modal.innerHTML = `
                <div class="modal-overlay active" id="requestModal">
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">Request Service</h3>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="requestForm">
                                <div class="form-group">
                                    <label>Service Plan</label>
                                    <select name="service_plan_id" id="serviceSelect" required>
                                        <option value="">Select a service plan</option>
                                        ${(svcData.services || []).map(s => `
                                            <optgroup label="${s.name}">
                                                ${(s.service_plans || []).map(p => `<option value="${p.id}" ${p.id === servicePlanId ? 'selected' : ''}>${p.name} - KES ${parseFloat(p.price || 0).toLocaleString()}</option>`).join('')}
                                            </optgroup>
                                        `).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Title</label>
                                    <input type="text" name="title" placeholder="Brief description of your request" required>
                                </div>
                                <div class="form-group">
                                    <label>Description</label>
                                    <textarea name="description" rows="3" placeholder="Provide more details about your request"></textarea>
                                </div>
                                <div class="form-group">
                                    <label>Priority</label>
                                    <select name="priority">
                                        <option value="normal">Normal</option>
                                        <option value="high">High</option>
                                        <option value="urgent">Urgent</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="submitRequest()"><i class="fas fa-paper-plane"></i> Submit Request</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function submitRequest() {
            const form = document.getElementById('requestForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            try {
                const res = await fetch('/customer-requests', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    closeModal();
                    showToast('Request submitted successfully!');
                    showPage('requests');
                } else {
                    const err = await res.json();
                    showToast(err.error || 'Failed to submit request');
                }
            } catch(e) {
                showToast(e.message);
            }
        }

        function quickRequest(planId, planName) {
            document.getElementById('serviceSelect').value = planId;
            showRequestModal(planId);
            document.querySelector('[name="title"]').value = planName + ' - Service Request';
        }

        function closeModal() {
            document.getElementById('modalContainer').innerHTML = '';
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }

        init();
    </script>
</body>
</html>
