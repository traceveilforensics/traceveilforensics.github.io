<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Dashboard | Trace Veil Forensics</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.png" sizes="32x32" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #0A1628;
            --secondary: #1E3A5F;
            --accent: #FFD700;
            --accent-hover: #e6c200;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --purple: #8b5cf6;
            --pink: #ec4899;
            --cyan: #06b6d4;
            --sidebar-width: 280px;
            --header-height: 70px;
            --bg-dark: #0a0f1a;
            --bg-card: #121a2e;
            --bg-light: #1a2540;
            --bg-hover: #1e2a45;
            --border-color: #2a3650;
            --text-primary: #e8ecf4;
            --text-secondary: #8892a8;
            --glass-bg: rgba(18, 26, 46, 0.8);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            background-image: 
                radial-gradient(ellipse at 0% 0%, rgba(255,215,0,0.03) 0%, transparent 50%),
                radial-gradient(ellipse at 100% 100%, rgba(30,58,95,0.1) 0%, transparent 50%);
        }

        .dashboard-layout {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #0d1525 0%, #0a0f1a 100%);
            color: white;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 4px 0 30px rgba(0,0,0,0.3);
            border-right: 1px solid rgba(255,215,0,0.05);
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: radial-gradient(ellipse at center top, rgba(255,215,0,0.08), transparent 70%);
            pointer-events: none;
        }

        .sidebar-header {
            padding: 28px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            text-align: center;
            position: relative;
        }

        .sidebar-header img {
            height: 40px;
            filter: drop-shadow(0 2px 8px rgba(255,215,0,0.3));
        }

        .sidebar-header a {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 12px;
            display: block;
            margin-top: 12px;
            transition: all 0.2s;
        }

        .sidebar-header a:hover {
            color: var(--accent);
        }

        .sidebar-nav {
            padding: 20px 12px;
            position: relative;
        }

        .nav-section {
            margin-bottom: 28px;
        }

        .nav-section-title {
            padding: 8px 12px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: rgba(255,215,0,0.5);
            font-weight: 700;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            color: rgba(255,255,255,0.65);
            text-decoration: none;
            border-radius: 12px;
            margin-bottom: 6px;
            transition: all 0.25s ease;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 0;
            background: var(--accent);
            border-radius: 0 3px 3px 0;
            transition: height 0.2s ease;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.05);
            color: white;
            transform: translateX(4px);
        }

        .nav-item:hover::before {
            height: 60%;
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(255,215,0,0.15), rgba(255,215,0,0.05));
            color: var(--accent);
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(255,215,0,0.15);
        }

        .nav-item.active::before {
            height: 60%;
        }

        .nav-item.active i {
            color: var(--accent);
        }

        .nav-item i {
            width: 22px;
            margin-right: 12px;
            font-size: 17px;
            color: rgba(255,255,255,0.5);
            transition: color 0.2s;
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            flex: 1;
            min-height: 100vh;
            background: transparent;
        }

        .page-header {
            background: linear-gradient(180deg, rgba(13,21,37,0.95) 0%, rgba(10,15,26,0.98) 100%);
            backdrop-filter: blur(10px);
            padding: 24px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,215,0,0.08);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .page-title {
            font-size: 26px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            letter-spacing: -0.5px;
        }

        .welcome-text {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 4px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, #ffc107 100%);
            color: #0a0f1a;
            box-shadow: 0 4px 15px rgba(255,215,0,0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(255,215,0,0.4);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.08);
            color: var(--text-primary);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.12);
            border-color: var(--accent);
        }

        .page-content {
            padding: 32px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: linear-gradient(145deg, var(--bg-card) 0%, #0d1322 100%);
            border-radius: 20px;
            padding: 26px;
            border: 1px solid var(--border-color);
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.4);
            border-color: rgba(255,215,0,0.3);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-bottom: 14px;
        }

        .stat-icon.blue { background: rgba(59, 130, 246, 0.12); color: #60a5fa; }
        .stat-icon.green { background: rgba(16, 185, 129, 0.12); color: #34d399; }
        .stat-icon.yellow { background: rgba(245, 158, 11, 0.12); color: #fbbf24; }
        .stat-icon.red { background: rgba(239, 68, 68, 0.12); color: #f87171; }
        .stat-icon.purple { background: rgba(139, 92, 246, 0.12); color: #a78bfa; }
        .stat-icon.cyan { background: rgba(6, 182, 212, 0.12); color: #22d3ee; }

        .stat-value {
            font-size: 34px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 6px;
            letter-spacing: -1px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Cards */
        .card {
            background: linear-gradient(145deg, var(--bg-card) 0%, #0d1322 100%);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            margin-bottom: 24px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .card-header {
            padding: 22px 26px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .card-body {
            padding: 26px;
        }

        /* Tables */
        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th, .table td {
            padding: 16px 18px;
            text-align: left;
            border-bottom: 1px solid rgba(42,54,80,0.5);
        }

        .table th {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: rgba(0,0,0,0.15);
        }

        .table tbody tr {
            transition: all 0.2s;
        }

        .table tbody tr:hover {
            background: rgba(255,215,0,0.03);
        }

        /* Status Badges */
        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: capitalize;
        }

        .status-draft { background: rgba(107,114,128,0.2); color: #9ca3af; }
        .status-sent { background: rgba(59,130,246,0.2); color: #60a5fa; }
        .status-paid { background: rgba(16,185,129,0.2); color: #34d399; }
        .status-overdue { background: rgba(239,68,68,0.2); color: #f87171; }
        .status-pending { background: rgba(245,158,11,0.2); color: #fbbf24; }
        .status-completed { background: rgba(16,185,129,0.2); color: #34d399; }
        .status-in_progress { background: rgba(59,130,246,0.2); color: #60a5fa; }
        .status-cancelled { background: rgba(107,114,128,0.2); color: #9ca3af; }

        /* Action Buttons */
        .action-btn {
            padding: 8px 14px;
            border: none;
            background: var(--bg-light);
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--accent);
            color: #0a0f1a;
            transform: scale(1.05);
        }

        /* Service Cards */
        .service-card {
            background: linear-gradient(145deg, var(--bg-light) 0%, #141e33 100%);
            border-radius: 16px;
            padding: 26px;
            margin-bottom: 18px;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .service-card:hover {
            border-color: rgba(255,215,0,0.4);
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        }

        .service-card h4 {
            margin: 0 0 14px 0;
            color: var(--text-primary);
            font-size: 19px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .service-card h4 i {
            color: var(--accent);
            font-size: 18px;
        }

        .service-card p {
            color: var(--text-secondary);
            margin-bottom: 18px;
            line-height: 1.7;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: linear-gradient(145deg, var(--bg-card) 0%, #0d1322 100%);
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            box-shadow: 0 25px 60px rgba(0,0,0,0.4);
        }

        .modal-header {
            padding: 22px 26px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 26px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .modal-close:hover {
            color: var(--accent);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 26px;
        }

        .form-group {
            margin-bottom: 22px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
            background: var(--bg-dark);
            color: var(--text-primary);
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(255,215,0,0.1);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .modal-footer {
            padding: 20px 26px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 52px;
            margin-bottom: 18px;
            opacity: 0.4;
            color: var(--accent);
        }

        /* Review Cards */
        .review-card {
            background: var(--bg-light);
            border-radius: 14px;
            padding: 22px;
            margin-bottom: 16px;
            border: 1px solid var(--border-color);
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .review-rating {
            font-size: 16px;
        }

        .review-date {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .review-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .review-text {
            color: var(--text-secondary);
            line-height: 1.7;
            font-size: 14px;
        }

        /* Mobile */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-primary);
        }

        /* Profile Section */
        .profile-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .profile-info h3 {
            margin-top: 0;
            color: var(--text-primary);
            margin-bottom: 22px;
            font-size: 18px;
            font-weight: 600;
        }

        .info-item {
            display: flex;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .info-label {
            width: 140px;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 13px;
        }

        .info-value {
            flex: 1;
            color: var(--text-primary);
            font-size: 14px;
        }

        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                z-index: 9999;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                width: 100%;
            }

            .mobile-menu-btn {
                display: flex !important;
                align-items: center;
                justify-content: center;
                width: 40px;
                height: 40px;
                background: var(--accent);
                color: #0A1628;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 18px;
                margin-right: 15px;
                float: left;
            }

            .page-header {
                display: flex !important;
                flex-direction: row !important;
                align-items: center !important;
            }

            .page-title {
                display: inline-block;
            }

            .profile-section {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .page-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
                padding: 20px;
            }

            .header-right {
                width: 100%;
                flex-wrap: wrap;
            }

            .page-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="LOGO_NAME_optimized.png" alt="Trace Veil Forensics">
                <a href="index.html"><i class="fas fa-home"></i> Back to Website</a>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Dashboard</div>
                    <a href="#" class="nav-item active" data-page="overview">
                        <i class="fas fa-tachometer-alt"></i>
                        Overview
                    </a>
                    <a href="#" class="nav-item" data-page="invoices">
                        <i class="fas fa-file-invoice"></i>
                        My Invoices
                    </a>
                    <a href="#" class="nav-item" data-page="requests">
                        <i class="fas fa-clipboard-list"></i>
                        Service Requests
                    </a>
                    <a href="#" class="nav-item" data-page="review">
                        <i class="fas fa-star"></i>
                        Reviews
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Account</div>
                    <a href="#" class="nav-item" data-page="profile">
                        <i class="fas fa-user"></i>
                        My Profile
                    </a>
                    <a href="#" class="nav-item" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </a>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <div>
                    <button class="mobile-menu-btn" id="mobileMenuBtn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title" id="pageTitle">Dashboard</h1>
                    <p class="welcome-text" id="welcomeText">Welcome back!</p>
                </div>
                <div class="header-right">
                    <button class="btn btn-secondary" onclick="showCustomRequestModal()">
                        <i class="fas fa-star"></i> Custom Quote
                    </button>
                    <button class="btn btn-primary" onclick="showRequestModal()">
                        <i class="fas fa-plus"></i> Request Service
                    </button>
                </div>
            </div>

            <div class="page-content" id="contentArea">
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Request Service</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
        </div>
    </div>

    <script src="auth.js"></script>
    <script>
        let currentUser = null;

        function init() {
            // Check both localStorage and sessionStorage
            let token = localStorage.getItem('token');
            let user = localStorage.getItem('user');
            
            if (!token) {
                token = sessionStorage.getItem('token');
                user = sessionStorage.getItem('user');
            }

            if (!token || !user) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = JSON.parse(user);
            document.getElementById('welcomeText').textContent = `Welcome back, ${currentUser.first_name || currentUser.email}!`;

            loadOverview();
            setupNavigation();
        }

        function setupNavigation() {
            document.querySelectorAll('.nav-item[data-page]').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage(item.dataset.page);
                });
            });

            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('mobileMenuBtn').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('active');
            });
            
            document.addEventListener('click', (e) => {
                const sidebar = document.getElementById('sidebar');
                const menuBtn = document.getElementById('mobileMenuBtn');
                if (window.innerWidth <= 1024 && 
                    sidebar.classList.contains('active') && 
                    !sidebar.contains(e.target) && 
                    !menuBtn.contains(e.target)) {
                    sidebar.classList.remove('active');
                }
            });
        }

        function showPage(page) {
            document.getElementById('pageTitle').textContent = page.charAt(0).toUpperCase() + page.slice(1);
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`.nav-item[data-page="${page}"]`)?.classList.add('active');

            switch(page) {
                case 'overview':
                    loadOverview();
                    break;
                case 'invoices':
                    loadInvoices();
                    break;
                case 'requests':
                    loadRequests();
                    break;
                case 'review':
                    loadReviews();
                    break;
                case 'profile':
                    loadProfile();
                    break;
            }
        }

        function loadOverview() {
            const user = currentUser;
            const userEmail = user.email;
            
            const allInvoices = window.authSystem.getInvoices();
            const allRequests = window.authSystem.getServiceRequests();
            
            const myInvoices = allInvoices.filter(inv => inv.customer_email && inv.customer_email.toLowerCase() === userEmail.toLowerCase());
            const myRequests = allRequests.filter(req => req.customer_email && req.customer_email.toLowerCase() === userEmail.toLowerCase());
            
            const totalInvoices = myInvoices.length;
            const paidInvoices = myInvoices.filter(i => i.status === 'paid').length;
            const pendingInvoices = myInvoices.filter(i => i.status === 'pending' || i.status === 'sent').length;
            const activeRequests = myRequests.filter(r => r.status === 'in_progress' || r.status === 'pending').length;

            document.getElementById('contentArea').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon purple">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <div class="stat-value">${totalInvoices}</div>
                        <div class="stat-label">Total Invoices</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-value">${paidInvoices}</div>
                        <div class="stat-label">Paid Invoices</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon yellow">
                            <i class="fas fa-hourglass-half"></i>
                        </div>
                        <div class="stat-value">${pendingInvoices}</div>
                        <div class="stat-label">Pending Payment</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon cyan">
                            <i class="fas fa-tasks-alt"></i>
                        </div>
                        <div class="stat-value">${activeRequests}</div>
                        <div class="stat-label">Active Requests</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Recent Invoices</h3>
                        <button class="btn btn-secondary" onclick="showPage('invoices')">View All</button>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Invoice #</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Due Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${myInvoices.length > 0 ? myInvoices.slice(0, 5).map(inv => `
                                    <tr>
                                        <td style="color: var(--text-primary); font-weight: 600;">${inv.invoice_number}</td>
                                        <td style="color: var(--text-primary);">KES ${parseFloat(inv.total).toLocaleString()}</td>
                                        <td><span class="status-badge status-${inv.status}">${inv.status}</span></td>
                                        <td style="color: var(--text-secondary);">${inv.due_date ? new Date(inv.due_date).toLocaleDateString() : '-'}</td>
                                        <td>
                                            <button class="action-btn" onclick="viewInvoiceDetail('${inv.id}')" title="View"><i class="fas fa-eye"></i></button>
                                                <button class="action-btn" onclick="downloadInvoice('${inv.id}')" title="Download"><i class="fas fa-download"></i></button>
                                        </td>
                                    </tr>
                                `).join('') : '<tr><td colspan="5" class="empty-state"><i class="fas fa-file-invoice"></i><p>No invoices found</p></td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Service Requests</h3>
                        <button class="btn btn-primary" onclick="showRequestModal()">New Request</button>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Service</th>
                                    <th>Status</th>
                                    <th>Priority</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${myRequests.length > 0 ? myRequests.slice(0, 5).map(req => `
                                    <tr>
                                        <td style="color: var(--text-primary); font-weight: 600;">${req.title || req.service_name || 'Service Request'}</td>
                                        <td style="color: var(--text-secondary);">${req.service_name || '-'}</td>
                                        <td><span class="status-badge status-${req.status}">${req.status}</span></td>
                                        <td><span class="status-badge status-${req.priority === 'high' ? 'overdue' : req.priority === 'urgent' ? 'overdue' : 'pending'}">${req.priority || 'normal'}</span></td>
                                        <td style="color: var(--text-secondary);">${req.created_date ? new Date(req.created_date).toLocaleDateString() : '-'}</td>
                                    </tr>
                                `).join('') : '<tr><td colspan="5" class="empty-state"><i class="fas fa-clipboard-list"></i><p>No requests found</p></td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function loadInvoices() {
            const userEmail = currentUser.email;
            const allInvoices = window.authSystem.getInvoices();
            const myInvoices = allInvoices.filter(inv => inv.customer_email && inv.customer_email.toLowerCase() === userEmail.toLowerCase());

            document.getElementById('contentArea').innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">My Invoices</h3>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Invoice #</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Issue Date</th>
                                    <th>Due Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${myInvoices.length > 0 ? myInvoices.map(inv => `
                                    <tr>
                                        <td style="color: var(--text-primary); font-weight: 600;">${inv.invoice_number}</td>
                                        <td style="color: var(--text-primary);">KES ${parseFloat(inv.total).toLocaleString()}</td>
                                        <td><span class="status-badge status-${inv.status}">${inv.status}</span></td>
                                        <td style="color: var(--text-secondary);">${inv.created_date ? new Date(inv.created_date).toLocaleDateString() : '-'}</td>
                                        <td style="color: var(--text-secondary);">${inv.due_date ? new Date(inv.due_date).toLocaleDateString() : '-'}</td>
                                        <td>
                                            <button class="action-btn" onclick="viewInvoiceDetail('${inv.id}')" title="View"><i class="fas fa-eye"></i></button>
                                                <button class="action-btn" onclick="downloadInvoice('${inv.id}')" title="Download"><i class="fas fa-download"></i></button>
                                        </td>
                                    </tr>
                                `).join('') : '<tr><td colspan="6" class="empty-state"><i class="fas fa-file-invoice"></i><p>No invoices found</p></td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function loadRequests() {
            const userEmail = currentUser.email;
            const allRequests = window.authSystem.getServiceRequests();
            const myRequests = allRequests.filter(req => req.customer_email === userEmail);

            document.getElementById('contentArea').innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">My Service Requests</h3>
                        <button class="btn btn-primary" onclick="showRequestModal()">New Request</button>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Service Plan</th>
                                    <th>Status</th>
                                    <th>Priority</th>
                                    <th>Requested</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${myRequests.length > 0 ? myRequests.map(req => `
                                    <tr>
                                        <td style="color: var(--text-primary); font-weight: 600;">${req.title || req.service_name || 'Service Request'}</td>
                                        <td style="color: var(--text-secondary);">${req.plan_name || req.service_name || 'Custom'}</td>
                                        <td><span class="status-badge status-${req.status}">${req.status}</span></td>
                                        <td><span class="status-badge status-${req.priority === 'high' ? 'overdue' : req.priority === 'urgent' ? 'overdue' : 'pending'}">${req.priority || 'normal'}</span></td>
                                        <td style="color: var(--text-secondary);">${req.created_date ? new Date(req.created_date).toLocaleDateString() : '-'}</td>
                                    </tr>
                                `).join('') : '<tr><td colspan="5" class="empty-state"><i class="fas fa-clipboard-list"></i><p>No requests found</p></td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        const REVIEWS_KEY = 'customer_reviews';

        function getReviews() {
            let reviews = JSON.parse(localStorage.getItem(REVIEWS_KEY) || '[]');
            
            // Add sample reviews if none exist
            if (reviews.length === 0) {
                reviews = [
                    {
                        id: 1,
                        customer_email: "customer@traceveilforensics.com",
                        customer_name: "John Doe",
                        rating: 5,
                        title: "Excellent Security Assessment",
                        content: "Trace Veil Forensics conducted a thorough vulnerability assessment of our network infrastructure. Their team identified critical vulnerabilities that we were unaware of and provided actionable recommendations. The report was detailed and easy to understand. Highly recommended!",
                        date: new Date().toISOString()
                    },
                    {
                        id: 2,
                        customer_email: "test@test.com",
                        customer_name: "Sarah Johnson",
                        rating: 5,
                        title: "Professional and Thorough Service",
                        content: "We hired Trace Veil for a comprehensive security audit of our web applications. The team was professional, knowledgeable, and delivered the report on time. They even provided a follow-up consultation to explain the findings. Great service!",
                        date: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString()
                    },
                    {
                        id: 3,
                        customer_email: "ariesgemini1st@gmail.com",
                        customer_name: "Michael Chen",
                        rating: 4,
                        title: "Great Security Consultation",
                        content: "The security assessment exceeded our expectations. The team identified several weaknesses in our system and helped us implement proper security measures. The detailed report helped us improve our overall security posture significantly.",
                        date: new Date(Date.now() - 14 * 24 * 60 * 60 * 1000).toISOString()
                    }
                ];
                localStorage.setItem(REVIEWS_KEY, JSON.stringify(reviews));
            }
            
            return reviews;
        }

        function saveReviews(reviews) {
            localStorage.setItem(REVIEWS_KEY, JSON.stringify(reviews));
        }

        function loadReviews() {
            const reviews = getReviews();
            const userEmail = currentUser.email;
            
            // Show all reviews (not filtered by user)
            const allReviews = reviews;

            document.getElementById('contentArea').innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Customer Reviews</h3>
                        <button class="btn btn-primary" onclick="showReviewModal()">
                            <i class="fas fa-plus"></i> Write Review
                        </button>
                    </div>
                    <div class="card-body">
                        ${allReviews.length > 0 ? allReviews.map(review => `
                            <div class="review-card">
                                <div class="review-header">
                                    <div class="review-rating">
                                        ${generateStars(review.rating)}
                                    </div>
                                    <span class="review-date">${new Date(review.date).toLocaleDateString()}</span>
                                </div>
                                <h4 class="review-title">${review.title}</h4>
                                <p class="review-text">${review.content}</p>
                                <p class="review-author" style="font-size: 12px; color: var(--text-secondary); margin-top: 10px;">- ${review.customer_name}</p>
                            </div>
                        `).join('') : '<div class="empty-state"><i class="fas fa-star"></i><p>No reviews yet. Share your experience with us!</p></div>'}
                    </div>
                </div>
            `;
        }

        function generateStars(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<i class="fas fa-star" style="color: var(--accent);"></i>';
                } else {
                    stars += '<i class="fas fa-star" style="color: var(--border-color);"></i>';
                }
            }
            return stars;
        }

        function showReviewModal() {
            document.getElementById('modalTitle').textContent = 'Write a Review';
            document.getElementById('modalBody').innerHTML = `
                <form id="reviewForm">
                    <div class="form-group">
                        <label>Rating</label>
                        <div class="rating-select" style="display: flex; gap: 8px; margin-top: 8px;">
                            ${[1,2,3,4,5].map(i => `<button type="button" class="rating-btn" data-rating="${i}" onclick="selectRating(${i})"><i class="fas fa-star"></i></button>`).join('')}
                        </div>
                        <input type="hidden" name="rating" id="ratingInput" required>
                    </div>
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" name="title" placeholder="Summarize your review" required>
                    </div>
                    <div class="form-group">
                        <label>Your Review</label>
                        <textarea name="content" placeholder="Share your experience with Trace Veil Forensics..." required></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Submit Review</button>
                    </div>
                </form>
                <style>
                    .rating-select { justify-content: flex-start; }
                    .rating-btn {
                        background: var(--bg-light);
                        border: none;
                        width: 40px;
                        height: 40px;
                        border-radius: 8px;
                        cursor: pointer;
                        color: var(--border-color);
                        transition: all 0.2s;
                    }
                    .rating-btn:hover, .rating-btn.selected {
                        background: var(--accent);
                        color: var(--primary);
                    }
                </style>
            `;

            document.getElementById('reviewForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const rating = document.getElementById('ratingInput').value;
                
                if (!rating) {
                    alert('Please select a rating');
                    return;
                }

                const reviews = getReviews();
                const newReview = {
                    id: Date.now(),
                    customer_email: currentUser.email,
                    customer_name: `${currentUser.first_name || ''} ${currentUser.last_name || ''}`.trim() || currentUser.email,
                    rating: parseInt(rating),
                    title: formData.get('title'),
                    content: formData.get('content'),
                    date: new Date().toISOString()
                };
                
                reviews.push(newReview);
                saveReviews(reviews);
                
                closeModal();
                loadReviews();
            });

            openModal();
        }

        function selectRating(rating) {
            document.getElementById('ratingInput').value = rating;
            document.querySelectorAll('.rating-btn').forEach((btn, i) => {
                btn.classList.toggle('selected', i < rating);
            });
        }

        function showCustomRequestModal() {
            document.getElementById('modalTitle').textContent = 'Request Custom Quote';
            document.getElementById('modalBody').innerHTML = `
                <form id="customRequestForm">
                    <div class="form-group">
                        <label>Project/Service Title</label>
                        <input type="text" name="title" placeholder="Describe your project or service need" required>
                    </div>
                    <div class="form-group">
                        <label>Detailed Requirements</label>
                        <textarea name="description" placeholder="Please describe your requirements, project scope, timeline, and any specific needs..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Estimated Budget (Optional)</label>
                        <input type="text" name="budget" placeholder="e.g., KES 100,000 - 200,000">
                    </div>
                    <div class="form-group">
                        <label>Preferred Timeline</label>
                        <select name="timeline">
                            <option value="asap">As soon as possible</option>
                            <option value="1month">Within 1 month</option>
                            <option value="3months">Within 3 months</option>
                            <option value="flexible">Flexible</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Contact Method</label>
                        <select name="contact_method">
                            <option value="email">Email</option>
                            <option value="phone">Phone</option>
                            <option value="both">Both</option>
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Submit Request</button>
                    </div>
                </form>
            `;

            document.getElementById('customRequestForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData);

                const requests = window.authSystem.getServiceRequests();
                const newRequest = {
                    id: Date.now(),
                    customer_id: currentUser.id,
                    customer_name: `${currentUser.first_name || ''} ${currentUser.last_name || ''}`.trim(),
                    customer_email: currentUser.email,
                    customer_phone: currentUser.phone || '',
                    service_id: 0,
                    service_name: 'Custom Quote Request',
                    plan_name: 'Custom',
                    title: data.title,
                    description: data.description + '\n\nBudget: ' + data.budget + '\nTimeline: ' + data.timeline + '\nContact: ' + data.contact_method,
                    status: 'pending',
                    priority: 'normal',
                    notes: 'Custom quote request',
                    created_date: new Date().toISOString(),
                    completed_date: null
                };
                
                requests.push(newRequest);
                window.authSystem.saveServiceRequests(requests);
                
                closeModal();
                showPage('requests');
                alert('Your custom quote request has been submitted! We will contact you soon.');
            });

            openModal();
        }

        function loadProfile() {
            const user = currentUser;
            const customers = window.authSystem.getCustomers();
            const customer = customers.find(c => c.email.toLowerCase() === user.email.toLowerCase()) || { ...user };

            document.getElementById('contentArea').innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">My Profile</h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="showChangePasswordModal()">
                                <i class="fas fa-lock"></i> Change Password
                            </button>
                            <button class="btn btn-primary" onclick="showEditProfileModal()">
                                <i class="fas fa-edit"></i> Edit Profile
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="profile-section">
                            <div class="profile-info">
                                <h3>Personal Information</h3>
                                <div class="info-item">
                                    <span class="info-label">First Name</span>
                                    <span class="info-value">${user.first_name || '-'}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Last Name</span>
                                    <span class="info-value">${user.last_name || '-'}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Email</span>
                                    <span class="info-value">${user.email || '-'}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Phone</span>
                                    <span class="info-value">${user.phone || '-'}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Company</span>
                                    <span class="info-value">${customer.company_name || '-'}</span>
                                </div>
                            </div>
                            <div class="profile-info">
                                <h3>Account Information</h3>
                                <div class="info-item">
                                    <span class="info-label">Account ID</span>
                                    <span class="info-value">${customer.id || '-'}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Member Since</span>
                                    <span class="info-value">${customer.created_at ? new Date(customer.created_at).toLocaleDateString() : '-'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function showChangePasswordModal() {
            document.getElementById('modalTitle').textContent = 'Change Password';
            document.getElementById('modalBody').innerHTML = `
                <form id="changePasswordForm">
                    <div class="form-group">
                        <label>Current Password</label>
                        <input type="password" name="currentPassword" id="currentPassword" required placeholder="Enter current password">
                    </div>
                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" name="newPassword" id="newPassword" required placeholder="Enter new password" minlength="8">
                    </div>
                    <div class="form-group">
                        <label>Confirm New Password</label>
                        <input type="password" name="confirmPassword" id="confirmPassword" required placeholder="Confirm new password">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Change Password</button>
                    </div>
                </form>
            `;

            document.getElementById('changePasswordForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (newPassword !== confirmPassword) {
                    alert('New passwords do not match!');
                    return;
                }

                if (newPassword.length < 8) {
                    alert('Password must be at least 8 characters!');
                    return;
                }

                const userEmail = currentUser.email;
                let passwordVerified = false;
                let passwordUpdated = false;

                // Check in customers
                const customers = window.authSystem.getCustomers();
                const customerIndex = customers.findIndex(c => c.email.toLowerCase() === userEmail.toLowerCase());

                if (customerIndex !== -1) {
                    const storedPassword = customers[customerIndex].password;
                    // If no password set, allow setting one with any current password input
                    if (!storedPassword || storedPassword === '') {
                        customers[customerIndex].password = newPassword;
                        window.authSystem.saveCustomers(customers);
                        passwordUpdated = true;
                    } else if (storedPassword === currentPassword) {
                        passwordVerified = true;
                        customers[customerIndex].password = newPassword;
                        window.authSystem.saveCustomers(customers);
                        passwordUpdated = true;
                    }
                }

                // Check in registered_users if not found in customers or password not verified
                if (!passwordUpdated) {
                    const users = window.authSystem.getRegisteredUsers();
                    const registeredUser = Object.keys(users).find(key => key.toLowerCase() === userEmail.toLowerCase());
                    
                    if (registeredUser) {
                        const storedPassword = users[registeredUser].password;
                        if (!storedPassword || storedPassword === '') {
                            users[registeredUser].password = newPassword;
                            localStorage.setItem('registered_users', JSON.stringify(users));
                            passwordUpdated = true;
                        } else if (storedPassword === currentPassword) {
                            users[registeredUser].password = newPassword;
                            localStorage.setItem('registered_users', JSON.stringify(users));
                            passwordUpdated = true;
                        }
                    }
                }

                if (passwordUpdated) {
                    alert('Password changed successfully! Please log in again with your new password.');
                    closeModal();
                    logout();
                } else {
                    alert('Current password is incorrect!');
                }
            });

            openModal();
        }

        function showRequestModal() {
            document.getElementById('modalTitle').textContent = 'Request Service';
            const services = window.authSystem.getServices();
            const pricing = window.authSystem.getPricing();
            
            let serviceOptions = '';
            services.forEach(service => {
                const plans = pricing.filter(p => p.service_id === service.id);
                if (plans.length > 0) {
                    plans.forEach(plan => {
                        serviceOptions += `<option value="${plan.id}">${service.name} - ${plan.name} (KES ${parseFloat(plan.price).toLocaleString()})</option>`;
                    });
                } else {
                    serviceOptions += `<option value="${service.id}">${service.name}</option>`;
                }
            });

            document.getElementById('modalBody').innerHTML = `
                <form id="requestForm">
                    <div class="form-group">
                        <label>Service Type</label>
                        <select name="service_id" id="serviceSelect" required>
                            <option value="">Select a service</option>
                            ${serviceOptions}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" name="title" placeholder="Brief description of your request" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea name="description" placeholder="Provide details about your requirements"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Priority</label>
                        <select name="priority">
                            <option value="normal">Normal</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Submit Request</button>
                    </div>
                </form>
            `;

            document.getElementById('requestForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData);
                
                const services = window.authSystem.getServices();
                const pricing = window.authSystem.getPricing();
                const service = services.find(s => s.id == data.service_id);
                const plan = pricing.find(p => p.id == data.service_id);

                const requests = window.authSystem.getServiceRequests();
                const newRequest = {
                    id: Date.now(),
                    customer_id: currentUser.id,
                    customer_name: `${currentUser.first_name || ''} ${currentUser.last_name || ''}`.trim(),
                    customer_email: currentUser.email,
                    customer_phone: currentUser.phone || '',
                    service_id: data.service_id,
                    service_name: service?.name || 'Custom Service',
                    plan_name: plan?.name || 'Custom',
                    title: data.title,
                    description: data.description,
                    status: 'pending',
                    priority: data.priority,
                    notes: '',
                    created_date: new Date().toISOString(),
                    completed_date: null
                };
                
                requests.push(newRequest);
                window.authSystem.saveServiceRequests(requests);
                
                closeModal();
                showPage('requests');
            });

            openModal();
        }

        function showEditProfileModal() {
            const user = currentUser;
            const customers = window.authSystem.getCustomers();
            const customer = customers.find(c => c.email.toLowerCase() === user.email.toLowerCase()) || {};
            
            document.getElementById('modalTitle').textContent = 'Edit Profile';
            document.getElementById('modalBody').innerHTML = `
                <form id="profileForm">
                    <h4 style="margin-top: 0; color: var(--text-primary);">Personal Information</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>First Name</label>
                            <input type="text" name="first_name" value="${user.first_name || ''}" required>
                        </div>
                        <div class="form-group">
                            <label>Last Name</label>
                            <input type="text" name="last_name" value="${user.last_name || ''}" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="text" name="phone" value="${user.phone || ''}">
                    </div>
                    <div class="form-group">
                        <label>Company Name</label>
                        <input type="text" name="company_name" value="${customer.company_name || ''}">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            `;

            document.getElementById('profileForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData);
                const userEmail = currentUser.email;
                
                // Update in customers
                const customers = window.authSystem.getCustomers();
                const customerIndex = customers.findIndex(c => c.email.toLowerCase() === userEmail.toLowerCase());
                
                if (customerIndex !== -1) {
                    customers[customerIndex] = {
                        ...customers[customerIndex],
                        first_name: data.first_name,
                        last_name: data.last_name,
                        phone: data.phone,
                        company_name: data.company_name
                    };
                    window.authSystem.saveCustomers(customers);
                }
                
                // Update in registered_users if exists
                const users = window.authSystem.getRegisteredUsers();
                const registeredUser = Object.keys(users).find(key => key.toLowerCase() === userEmail.toLowerCase());
                if (registeredUser) {
                    users[registeredUser] = {
                        ...users[registeredUser],
                        first_name: data.first_name,
                        last_name: data.last_name,
                        phone: data.phone
                    };
                    localStorage.setItem('registered_users', JSON.stringify(users));
                }
                
                // Update current user session
                const updatedUser = { ...currentUser, ...data };
                localStorage.setItem('user', JSON.stringify(updatedUser));
                sessionStorage.setItem('user', JSON.stringify(updatedUser));
                currentUser = updatedUser;
                
                closeModal();
                loadProfile();
                alert('Profile updated successfully!');
            });

            openModal();
        }

        function viewInvoiceDetail(id) {
            const invoices = window.authSystem.getInvoices();
            const invoice = invoices.find(i => i.id == id);
            
            if (!invoice) return;
            
            document.getElementById('modalTitle').textContent = `Invoice ${invoice.invoice_number}`;
            document.getElementById('modalBody').innerHTML = `
                <div class="invoice-detail" style="margin-bottom: 20px;">
                    <div class="info-item">
                        <span class="info-label">Invoice Number</span>
                        <span class="info-value" style="font-weight: 600; color: var(--accent);">${invoice.invoice_number}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Amount</span>
                        <span class="info-value" style="font-size: 18px; font-weight: 700;">KES ${parseFloat(invoice.total).toLocaleString()}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Status</span>
                        <span class="info-value"><span class="status-badge status-${invoice.status}">${invoice.status}</span></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Issue Date</span>
                        <span class="info-value">${invoice.created_date ? new Date(invoice.created_date).toLocaleDateString() : '-'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Due Date</span>
                        <span class="info-value">${invoice.due_date ? new Date(invoice.due_date).toLocaleDateString() : '-'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Paid Date</span>
                        <span class="info-value">${invoice.paid_date ? new Date(invoice.paid_date).toLocaleDateString() : '-'}</span>
                    </div>
                </div>
                ${invoice.items && invoice.items.length > 0 ? `
                <div style="margin-top: 20px;">
                    <h4 style="color: var(--text-primary); margin-bottom: 12px; font-size: 14px; text-transform: uppercase; letter-spacing: 1px;">Invoice Items</h4>
                    <table class="table" style="font-size: 13px;">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Qty</th>
                                <th>Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoice.items.map(item => `
                                <tr>
                                    <td style="color: var(--text-primary);">${item.description}</td>
                                    <td style="color: var(--text-secondary);">${item.quantity}</td>
                                    <td style="color: var(--text-secondary);">KES ${parseFloat(item.unit_price).toLocaleString()}</td>
                                    <td style="color: var(--text-primary); font-weight: 600;">KES ${parseFloat(item.total).toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ` : ''}
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Close</button>
                    <button type="button" class="btn btn-primary" onclick="downloadInvoice(${invoice.id})">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
            `;
            openModal();
        }

        function downloadInvoice(id) {
            const invoices = window.authSystem.getInvoices();
            const invoice = invoices.find(i => i.id == id);
            if (!invoice) return;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Invoice ${invoice.invoice_number}</title>
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { 
                            font-family: 'Segoe UI', Arial, sans-serif; 
                            padding: 40px; 
                            background: linear-gradient(135deg, #0d1f35 0%, #1e3a5f 100%);
                            min-height: 100vh;
                            color: #f1f5f9;
                        }
                        .invoice-container {
                            background: linear-gradient(135deg, #0d1f35 0%, #1e3a5f 100%);
                            border: 2px solid #334155;
                            border-radius: 16px;
                            padding: 40px;
                            max-width: 800px;
                            margin: 0 auto;
                        }
                        .header { 
                            display: flex; 
                            justify-content: space-between; 
                            align-items: center;
                            margin-bottom: 40px;
                            padding-bottom: 20px;
                            border-bottom: 2px solid rgba(255,215,0,0.3);
                        }
                        .company { display: flex; align-items: center; gap: 15px; }
                        .company img { height: 60px; border-radius: 8px; }
                        .company-info p { color: #94a3b8; font-size: 14px; margin-top: 4px; }
                        .invoice-info { text-align: right; }
                        .invoice-info h2 { color: #FFD700; font-size: 28px; margin-bottom: 8px; }
                        .invoice-info p { color: #94a3b8; font-size: 13px; margin: 4px 0; }
                        .status {
                            display: inline-block;
                            padding: 6px 14px;
                            border-radius: 6px;
                            font-size: 12px;
                            font-weight: 600;
                            text-transform: uppercase;
                            margin-top: 8px;
                            background: ${invoice.status === 'paid' ? 'rgba(16,185,129,0.2)' : invoice.status === 'pending' || invoice.status === 'sent' ? 'rgba(245,158,11,0.2)' : 'rgba(239,68,68,0.2)'};
                            color: ${invoice.status === 'paid' ? '#10b981' : invoice.status === 'pending' || invoice.status === 'sent' ? '#f59e0b' : '#ef4444'};
                        }
                        .bill-to {
                            background: rgba(0,0,0,0.2);
                            padding: 20px;
                            border-radius: 12px;
                            margin-bottom: 30px;
                        }
                        .bill-to h3 { color: #FFD700; margin-bottom: 12px; font-size: 16px; }
                        .bill-to p { color: #f1f5f9; margin: 4px 0; }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin: 20px 0;
                            background: rgba(0,0,0,0.2);
                            border-radius: 12px;
                            overflow: hidden;
                        }
                        th, td { padding: 16px; text-align: left; border-bottom: 1px solid #334155; }
                        th { 
                            background: rgba(255,215,0,0.1); 
                            color: #FFD700;
                            font-weight: 600;
                            text-transform: uppercase;
                            font-size: 12px;
                        }
                        td { color: #f1f5f9; }
                        tr:last-child td { border-bottom: none; }
                        .total-section {
                            background: linear-gradient(135deg, rgba(255,215,0,0.1) 0%, rgba(230,194,0,0.05) 100%);
                            border: 2px solid rgba(255,215,0,0.3);
                            border-radius: 12px;
                            padding: 24px;
                            margin-top: 20px;
                            text-align: right;
                        }
                        .total-section h2 { 
                            color: #FFD700; 
                            font-size: 32px; 
                        }
                        @media print {
                            @page { margin: 0.5in 0.5in 0.5in 0.5in; }
                            body { background: white; color: black; }
                            .invoice-container { border: 1px solid #ddd; box-shadow: none; }
                            th { background: #f5f5f5; color: black; }
                            td { color: black; }
                            .status { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <div class="invoice-container">
                        <div class="header">
                            <div class="company">
                                <img src="LOGO_NAME_optimized.png" alt="Trace Veil Forensics">
                                <div class="company-info">
                                    <p style="color: #f1f5f9; font-weight: 600; font-size: 16px;">Trace Veil Forensics</p>
                                    <p>Cybersecurity Consulting Services</p>
                                    <p>Kenya, East Africa</p>
                                </div>
                            </div>
                            <div class="invoice-info">
                                <h2>${invoice.invoice_number}</h2>
                                <p>Date: ${invoice.created_date}</p>
                                <p>Due: ${invoice.due_date}</p>
                                <span class="status">${invoice.status}</span>
                            </div>
                        </div>
                        <div class="bill-to">
                            <h3><i class="fas fa-user"></i> Bill To:</h3>
                            <p><strong>${invoice.customer_name}</strong></p>
                            <p>${invoice.customer_email}</p>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Qty</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${(invoice.items || []).map(item => `
                                    <tr>
                                        <td>${item.description}</td>
                                        <td>${item.quantity}</td>
                                        <td>KES ${item.unit_price.toLocaleString()}</td>
                                        <td>KES ${item.total.toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="total-section">
                            <h2>KES ${parseFloat(invoice.total).toLocaleString()}</h2>
                            <p style="color: #94a3b8; margin-top: 4px;">Total Amount Due</p>
                        </div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function requestService(serviceId) {
            showRequestModal();
        }

        function openModal() {
            document.getElementById('modalOverlay').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            sessionStorage.removeItem('token');
            sessionStorage.removeItem('user');
            window.location.href = 'index.html';
        }

        function getLoadingHTML() {
            return '<div class="card"><div class="card-body" style="text-align: center; padding: 60px;"><i class="fas fa-spinner fa-spin" style="font-size: 32px; color: var(--accent); animation: pulse 1.5s ease-in-out infinite;"></i><p style="margin-top: 16px; color: var(--text-secondary);">Loading...</p></div></div><style>@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }</style>';
        }

        init();
    </script>
</body>
</html>
