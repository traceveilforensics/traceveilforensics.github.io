<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Trace Veil Forensics</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --primary: #0A1628; --secondary: #1E3A5F; --accent: #FFD700; --sidebar-width: 260px; }
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background: #f0f2f5; min-height: 100vh; }
        .admin-layout { display: flex; }
        .sidebar { width: var(--sidebar-width); background: linear-gradient(180deg, var(--primary) 0%, #0d1a33 100%); color: white; min-height: 100vh; position: fixed; left: 0; top: 0; overflow-y: auto; z-index: 1000; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .sidebar-header { padding: 25px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center; background: rgba(0,0,0,0.2); }
        .sidebar-header img { max-width: 160px; margin-bottom: 5px; }
        .sidebar-header .brand { font-size: 12px; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
        .sidebar-nav { padding: 15px 0; }
        .nav-section { margin-bottom: 10px; }
        .nav-section-title { padding: 10px 20px 5px; font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: rgba(255,255,255,0.4); font-weight: 600; }
        .nav-item { display: flex; align-items: center; padding: 12px 20px; color: rgba(255,255,255,0.8); text-decoration: none; transition: all 0.2s; cursor: pointer; border-left: 3px solid transparent; margin: 2px 10px; border-radius: 6px; }
        .nav-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-item.active { background: rgba(255,215,0,0.15); color: var(--accent); border-left-color: var(--accent); }
        .nav-item i { width: 22px; margin-right: 10px; font-size: 16px; text-align: center; }
        .main-content { margin-left: var(--sidebar-width); flex: 1; padding: 30px; background: #f0f2f5; min-height: 100vh; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: white; padding: 20px 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .page-title { font-size: 24px; font-weight: 700; color: var(--primary); margin: 0; }
        .page-title i { color: var(--accent); margin-right: 10px; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 40px; height: 40px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); font-weight: 700; font-size: 16px; }
        .user-details { text-align: right; }
        .user-name { font-weight: 600; color: var(--primary); font-size: 14px; }
        .user-role { font-size: 12px; color: #888; }
        .btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .btn-primary { background: var(--accent); color: var(--primary); }
        .btn-primary:hover { background: #e6c200; transform: translateY(-1px); }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-secondary:hover { background: #2a4a7f; }
        .btn-success { background: #27ae60; color: white; }
        .btn-success:hover { background: #219a52; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 4px solid var(--accent); transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; margin-bottom: 15px; }
        .stat-icon.blue { background: linear-gradient(135deg, #1E3A5F 0%, #2a4a7f 100%); color: white; }
        .stat-icon.green { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); color: white; }
        .stat-icon.yellow { background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%); color: white; }
        .stat-icon.red { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--primary); margin-bottom: 5px; }
        .stat-label { font-size: 13px; color: #888; font-weight: 500; }
        .card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 25px; overflow: hidden; }
        .card-header { padding: 20px 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fafafa; }
        .card-title { font-size: 16px; font-weight: 600; color: var(--primary); margin: 0; display: flex; align-items: center; gap: 10px; }
        .card-title i { color: var(--accent); }
        .card-body { padding: 20px 25px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: #555; font-size: 13px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; box-sizing: border-box; transition: border-color 0.2s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--accent); }
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-draft { background: #f0f0f0; color: #666; }
        .status-sent { background: #e3f2fd; color: #1976d2; }
        .status-paid { background: #e8f5e9; color: #388e3c; }
        .status-overdue { background: #ffebee; color: #d32f2f; }
        .status-active { background: #e8f5e9; color: #388e3c; }
        .status-inactive { background: #f0f0f0; color: #666; }
        .action-btn { padding: 6px 10px; border: none; background: #f0f0f0; color: #666; cursor: pointer; border-radius: 6px; margin-right: 5px; transition: all 0.2s; }
        .action-btn:hover { background: var(--primary); color: white; }
        .action-btn.edit:hover { background: var(--secondary); }
        .action-btn.delete:hover { background: #e74c3c; }
        .service-icon { width: 36px; height: 36px; background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; }
        .empty-state { text-align: center; padding: 50px 20px; color: #999; }
        .empty-state i { font-size: 48px; color: #ddd; margin-bottom: 15px; }
        .plans-group { margin-bottom: 25px; }
        .plans-group:last-child { margin-bottom: 0; }
        .plans-header { display: flex; align-items: center; gap: 12px; padding: 12px 15px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); border-radius: 8px; margin-bottom: 12px; color: white; }
        .plans-header i { font-size: 18px; color: var(--accent); }
        .plans-header h4 { margin: 0; font-size: 15px; font-weight: 600; }
        .plans-header .count { margin-left: auto; background: rgba(255,255,255,0.2); padding: 3px 10px; border-radius: 12px; font-size: 11px; }
        .plan-item { display: flex; align-items: center; padding: 14px 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid var(--accent); transition: all 0.2s; }
        .plan-item:hover { background: #f0f2f5; transform: translateX(3px); }
        .plan-item:last-child { margin-bottom: 0; }
        .plan-info { flex: 1; }
        .plan-name { font-weight: 600; color: var(--primary); font-size: 14px; }
        .plan-desc { font-size: 12px; color: #888; margin-top: 2px; }
        .plan-price { font-weight: 700; color: var(--accent); font-size: 16px; margin-right: 15px; min-width: 100px; text-align: right; }
        .plan-billing { font-size: 11px; color: #888; background: #eee; padding: 3px 8px; border-radius: 4px; margin-right: 15px; }
        .plan-actions { display: flex; gap: 5px; }
        .login-box { max-width: 420px; margin: 80px auto; background: white; padding: 45px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); text-align: center; }
        .login-box h2 { color: var(--primary); margin-bottom: 8px; font-size: 24px; }
        .login-box p { color: #888; margin-bottom: 30px; font-size: 14px; }
        .login-box input { width: 100%; padding: 14px 16px; margin: 12px 0; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; box-sizing: border-box; transition: border-color 0.2s; }
        .login-box input:focus { outline: none; border-color: var(--accent); }
        .login-box button { width: 100%; padding: 14px; background: var(--primary); color: var(--accent); border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; margin-top: 10px; transition: all 0.2s; }
        .login-box button:hover { background: #0d1a33; transform: translateY(-2px); }
        .login-logo { max-width: 180px; margin-bottom: 20px; }
        .error-msg { color: #e74c3c; font-size: 13px; margin-top: 10px; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; border-radius: 16px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-header { padding: 20px 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: var(--primary); color: white; border-radius: 16px 16px 0 0; }
        .modal-title { margin: 0; font-size: 18px; font-weight: 600; }
        .modal-close { background: none; border: none; color: white; font-size: 28px; cursor: pointer; opacity: 0.8; transition: opacity 0.2s; }
        .modal-close:hover { opacity: 1; }
        .modal-body { padding: 25px; }
        .modal-footer { padding: 15px 25px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; background: #fafafa; border-radius: 0 0 16px 16px; }
        .row { display: flex; gap: 15px; }
        .col { flex: 1; }
        .toast { position: fixed; bottom: 30px; right: 30px; background: #27ae60; color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 3000; display: none; }
        .toast.show { display: block; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="toast" class="toast"></div>
    <div id="modalContainer"></div>
    <script>
        let currentUser = null;
        let token = null;

        async function init() {
            token = localStorage.getItem('token');
            const userStr = localStorage.getItem('user');
            if (!token || !userStr) { showLogin(); return; }
            try {
                currentUser = JSON.parse(userStr);
                if (currentUser.role !== 'admin') { showLogin(); return; }
                showDashboard();
            } catch(e) { showLogin(); }
        }

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.style.background = type === 'success' ? '#27ae60' : '#e74c3c';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function showLogin() {
            document.getElementById('app').innerHTML = `
                <div class="login-box">
                    <img src="LOGO_NAME_optimized.png" class="login-logo" alt="Trace Veil">
                    <h2>Admin Portal</h2>
                    <p>Sign in to manage your business</p>
                    <input type="email" id="email" value="admin@traceveilforensics.com" placeholder="Email Address">
                    <input type="password" id="password" value="Admin@123" placeholder="Password">
                    <button onclick="doLogin()">Sign In</button>
                    <p class="error-msg" id="errorMsg"></p>
                </div>
            `;
        }

        async function doLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                const res = await fetch('/api/auth-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if (res.ok) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    token = data.token;
                    currentUser = data.user;
                    showDashboard();
                } else {
                    document.getElementById('errorMsg').textContent = data.error || 'Login failed';
                }
            } catch(e) {
                document.getElementById('errorMsg').textContent = 'Network error';
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            token = null;
            currentUser = null;
            showLogin();
        }

        async function generateInvoicePDF(invoice) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const primaryColor = [10, 22, 40];
            const accentColor = [255, 215, 0];
            
            doc.setFillColor(...primaryColor);
            doc.rect(0, 0, 210, 45, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont('helvetica', 'bold');
            doc.text('Trace Veil Forensics', 20, 22);
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('Professional Cybersecurity Services', 20, 30);
            doc.text('P.O. Box 1234-00100, Nairobi, Kenya', 20, 36);
            
            doc.setTextColor(...accentColor);
            doc.setFontSize(28);
            doc.setFont('helvetica', 'bold');
            doc.text('INVOICE', 150, 30);
            
            doc.setDrawColor(...primaryColor);
            doc.setLineWidth(0.5);
            doc.line(15, 50, 195, 50);
            
            doc.setTextColor(60, 60, 60);
            doc.setFontSize(10);
            
            const invoiceX = 15;
            let yPos = 60;
            
            doc.setFont('helvetica', 'bold');
            doc.text('Invoice Number:', invoiceX, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(invoice.invoice_number || 'N/A', invoiceX + 45, yPos);
            
            doc.setFont('helvetica', 'bold');
            doc.text('Date:', invoiceX + 110, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(invoice.created_at ? new Date(invoice.created_at).toLocaleDateString() : new Date().toLocaleDateString(), invoiceX + 125, yPos);
            
            yPos += 12;
            doc.setFont('helvetica', 'bold');
            doc.text('Due Date:', invoiceX, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(invoice.due_date ? new Date(invoice.due_date).toLocaleDateString() : 'N/A', invoiceX + 45, yPos);
            
            doc.setFont('helvetica', 'bold');
            doc.text('Status:', invoiceX + 110, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text((invoice.status || 'draft').toUpperCase(), invoiceX + 125, yPos);
            
            yPos += 20;
            doc.setFillColor(245, 245, 245);
            doc.rect(15, yPos - 5, 180, 10, 'F');
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('Bill To:', 20, yPos + 2);
            
            yPos += 10;
            const customer = invoice.customers;
            if (customer) {
                doc.setFont('helvetica', 'bold');
                doc.text(customer.company_name || `${customer.users?.first_name || ''} ${customer.users?.last_name || ''}`, 20, yPos);
                yPos += 5;
                doc.setFont('helvetica', 'normal');
                if (customer.users?.email) {
                    doc.text(customer.users.email, 20, yPos);
                    yPos += 5;
                }
                if (customer.phone) {
                    doc.text(customer.phone, 20, yPos);
                    yPos += 5;
                }
                if (customer.address) {
                    doc.text(customer.address, 20, yPos);
                    yPos += 5;
                }
            } else {
                doc.setFont('helvetica', 'normal');
                doc.text('Customer information not available', 20, yPos);
            }
            
            yPos += 15;
            doc.setFillColor(...primaryColor);
            doc.rect(15, yPos, 180, 8, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text('Description', 20, yPos + 6);
            doc.text('Qty', 130, yPos + 6);
            doc.text('Unit Price', 150, yPos + 6);
            doc.text('Total', 180, yPos + 6);
            
            yPos += 12;
            doc.setTextColor(60, 60, 60);
            doc.setFont('helvetica', 'normal');
            
            const items = invoice.items || [{ description: invoice.description || 'Services', quantity: 1, unit_price: invoice.total, total: invoice.total }];
            
            items.forEach((item, index) => {
                if (index % 2 === 0) {
                    doc.setFillColor(250, 250, 250);
                    doc.rect(15, yPos - 3, 180, 8, 'F');
                }
                
                const desc = item.description || 'Service';
                const truncated = desc.length > 50 ? desc.substring(0, 47) + '...' : desc;
                doc.text(truncated, 20, yPos + 3);
                doc.text(String(item.quantity || 1), 130, yPos + 3);
                doc.text('KES ' + parseFloat(item.unit_price || 0).toLocaleString(), 150, yPos + 3);
                doc.text('KES ' + parseFloat(item.total || 0).toLocaleString(), 180, yPos + 3);
                yPos += 8;
            });
            
            yPos += 5;
            doc.setDrawColor(220, 220, 220);
            doc.line(15, yPos, 195, yPos);
            yPos += 10;
            
            const subtotal = parseFloat(invoice.subtotal || invoice.total || 0);
            const tax = parseFloat(invoice.tax || 0);
            const total = parseFloat(invoice.total || 0);
            
            doc.setFontSize(10);
            doc.text('Subtotal:', 150, yPos);
            doc.text('KES ' + subtotal.toLocaleString(), 180, yPos);
            
            if (tax > 0) {
                yPos += 7;
                doc.text('Tax:', 150, yPos);
                doc.text('KES ' + tax.toLocaleString(), 180, yPos);
            }
            
            yPos += 8;
            doc.setFillColor(...primaryColor);
            doc.rect(145, yPos - 4, 50, 10, 'F');
            doc.setTextColor(255, 215, 0);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('Total:', 150, yPos + 3);
            doc.text('KES ' + total.toLocaleString(), 180, yPos + 3);
            
            const footerY = 270;
            doc.setTextColor(150, 150, 150);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text('Thank you for your business!', 105, footerY, { align: 'center' });
            doc.text('Payment is due within 30 days. Please include invoice number on your check or transfer.', 105, footerY + 5, { align: 'center' });
            doc.text('Questions? Contact us at traceveilforensics@gmail.com or +254 731 570 131', 105, footerY + 10, { align: 'center' });
            
            const fileName = `Invoice_${invoice.invoice_number || 'unknown'}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
            showToast('Invoice PDF downloaded successfully');
        }

        function showDashboard() {
            document.getElementById('app').innerHTML = `
                <div class="admin-layout">
                    <aside class="sidebar">
                        <div class="sidebar-header">
                            <img src="LOGO_NAME_optimized.png" alt="Trace Veil Forensics">
                            <div class="brand">Admin Portal</div>
                        </div>
                        <nav class="sidebar-nav">
                            <div class="nav-section">
                                <div class="nav-section-title">Overview</div>
                                <a href="#" class="nav-item active" onclick="showPage('dashboard', this)"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                            </div>
                            <div class="nav-section">
                                <div class="nav-section-title">Services & Pricing</div>
                                <a href="#" class="nav-item" onclick="showPage('services', this)"><i class="fas fa-cogs"></i> Services</a>
                                <a href="#" class="nav-item" onclick="showPage('pricing', this)"><i class="fas fa-tags"></i> Pricing Plans</a>
                            </div>
                            <div class="nav-section">
                                <div class="nav-section-title">Accounting</div>
                                <a href="#" class="nav-item" onclick="showPage('invoices', this)"><i class="fas fa-file-invoice-dollar"></i> Invoices</a>
                                <a href="#" class="nav-item" onclick="showPage('customers', this)"><i class="fas fa-users"></i> Customers</a>
                                <a href="#" class="nav-item" onclick="showPage('reports', this)"><i class="fas fa-chart-pie"></i> Reports</a>
                            </div>
                            <div class="nav-section">
                                <div class="nav-section-title">Account</div>
                                <a href="index.html" class="nav-item"><i class="fas fa-globe"></i> View Website</a>
                                <a href="#" class="nav-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
                            </div>
                        </nav>
                    </aside>
                    <main class="main-content">
                        <div class="page-header">
                            <h1 class="page-title" id="pageTitle"><i class="fas fa-tachometer-alt"></i> Dashboard</h1>
                            <div class="user-info">
                                <div class="user-details">
                                    <div class="user-name">${currentUser.first_name} ${currentUser.last_name}</div>
                                    <div class="user-role">Administrator</div>
                                </div>
                                <div class="user-avatar">${currentUser.first_name?.charAt(0)}${currentUser.last_name?.charAt(0)}</div>
                            </div>
                        </div>
                        <div id="content"></div>
                    </main>
                </div>
            `;
            showPage('dashboard');
        }

        async function showPage(page, navEl) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if (navEl) navEl.classList.add('active');
            
            const titles = { dashboard: '<i class="fas fa-tachometer-alt"></i> Dashboard', services: '<i class="fas fa-cogs"></i> Services', pricing: '<i class="fas fa-tags"></i> Pricing Plans', invoices: '<i class="fas fa-file-invoice-dollar"></i> Invoices', customers: '<i class="fas fa-users"></i> Customers', reports: '<i class="fas fa-chart-pie"></i> Reports' };
            document.getElementById('pageTitle').innerHTML = titles[page];
            document.getElementById('content').innerHTML = '<div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Loading...</p></div>';
            const content = document.getElementById('content');

            try {
                switch(page) {
                    case 'dashboard': {
                        const r = await fetch('/api/admin-reports', { headers: { 'Authorization': 'Bearer ' + token } });
                        const d = await r.json();
                        content.innerHTML = `
                            <div class="stats-grid">
                                <div class="stat-card"><div class="stat-icon blue"><i class="fas fa-dollar-sign"></i></div><div class="stat-value">KES ${(d.totalRevenue||0).toLocaleString()}</div><div class="stat-label">Total Revenue</div></div>
                                <div class="stat-card"><div class="stat-icon yellow"><i class="fas fa-clock"></i></div><div class="stat-value">KES ${(d.pendingAmount||0).toLocaleString()}</div><div class="stat-label">Pending Payment</div></div>
                                <div class="stat-card"><div class="stat-icon green"><i class="fas fa-check-circle"></i></div><div class="stat-value">${d.invoiceStats?.paid||0}</div><div class="stat-label">Paid Invoices</div></div>
                                <div class="stat-card"><div class="stat-icon red"><i class="fas fa-exclamation-triangle"></i></div><div class="stat-value">${d.invoiceStats?.overdue||0}</div><div class="stat-label">Overdue</div></div>
                            </div>
                            <div class="card">
                                <div class="card-header"><h3 class="card-title"><i class="fas fa-file-invoice"></i> Recent Invoices</h3></div>
                                <div class="card-body">
                                    <table class="table"><thead><tr><th>Invoice #</th><th>Amount</th><th>Status</th><th>Due Date</th></tr></thead>
                                    <tbody>${(d.invoices||[]).slice(0,5).map(inv=>`<tr><td><strong>${inv.invoice_number||'N/A'}</strong></td><td>KES ${parseFloat(inv.total||0).toLocaleString()}</td><td><span class="status-badge status-${inv.status||'draft'}">${inv.status||'draft'}</span></td><td>${inv.due_date?new Date(inv.due_date).toLocaleDateString():'N/A'}</td></tr>`).join('') || '<tr><td colspan="4" style="text-align:center;color:#999;padding:40px;">No invoices yet</td></tr>'}</tbody></table>
                                </div>
                            </div>
                        `;
                        break;
                    }
                    case 'services': {
                        const r = await fetch('/api/admin-services', { headers: { 'Authorization': 'Bearer ' + token } });
                        const d = await r.json();
                        content.innerHTML = `
                            <div class="card">
                                <div class="card-header"><h3 class="card-title"><i class="fas fa-cogs"></i> All Services (${d.services?.length||0})</h3></div>
                                <div class="card-body">
                                    <table class="table"><thead><tr><th>Icon</th><th>Service Name</th><th>Slug</th><th>Plans</th><th>Status</th></tr></thead>
                                    <tbody>${(d.services||[]).map(s=>`<tr><td><div class="service-icon"><i class="fas ${s.icon||'fa-cog'}"></i></div></td><td><strong>${s.name}</strong><br><small style="color:#888">${s.description||''}</small></td><td><code style="background:#f0f0f0;padding:2px 6px;border-radius:4px;font-size:12px;">${s.slug}</code></td><td><span class="status-badge status-active">${s.service_plans?.length||0} plans</span></td><td><span class="status-badge status-${s.is_active?'active':'inactive'}">${s.is_active?'Active':'Inactive'}</span></td></tr>`).join('') || '<tr><td colspan="5" style="text-align:center;color:#999;padding:40px;">No services found</td></tr>'}</tbody></table>
                                </div>
                            </div>
                        `;
                        break;
                    }
                    case 'pricing': {
                        const [plansRes, servicesRes] = await Promise.all([
                            fetch('/api/admin-plans', { headers: { 'Authorization': 'Bearer ' + token } }),
                            fetch('/api/admin-services', { headers: { 'Authorization': 'Bearer ' + token } })
                        ]);
                        const plansData = await plansRes.json();
                        const servicesData = await servicesRes.json();
                        const plans = plansData.plans || [];
                        const services = servicesData.services || [];
                        
                        const grouped = {};
                        plans.forEach(p => {
                            const svcName = p.services?.name || 'Other';
                            if (!grouped[svcName]) grouped[svcName] = [];
                            grouped[svcName].push(p);
                        });
                        
                        let html = `<div class="card"><div class="card-header"><h3 class="card-title"><i class="fas fa-tags"></i> Pricing Plans (${plans.length})</h3><button class="btn btn-primary btn-sm" onclick="showAddPlanModal()"><i class="fas fa-plus"></i> Add New Plan</button></div><div class="card-body">`;
                        
                        if (plans.length === 0) {
                            html += '<div class="empty-state"><i class="fas fa-tags"></i><p>No pricing plans found. Click "Add New Plan" to create one.</p></div>';
                        } else {
                            for (const [svcName, svcPlans] of Object.entries(grouped)) {
                                const service = svcPlans[0].services;
                                html += `
                                    <div class="plans-group">
                                        <div class="plans-header">
                                            <i class="fas ${service?.icon||'fa-cog'}"></i>
                                            <h4>${svcName}</h4>
                                            <span class="count">${svcPlans.length} plan${svcPlans.length!==1?'s':''}</span>
                                        </div>
                                        ${svcPlans.map(p=>`
                                            <div class="plan-item">
                                                <div class="plan-info">
                                                    <div class="plan-name">${p.name}</div>
                                                    <div class="plan-desc">${p.description||''}</div>
                                                </div>
                                                <div class="plan-price">KES ${parseFloat(p.price||0).toLocaleString()}</div>
                                                <span class="plan-billing">${p.billing_cycle}</span>
                                                <div class="plan-actions">
                                                    <button class="action-btn edit" onclick="editPlan('${p.id}', '${p.name.replace(/'/g,"\\'")}', '${(p.description||'').replace(/'/g,"\\'")}', '${p.price}', '${p.billing_cycle}', '${p.service_id}')"><i class="fas fa-edit"></i></button>
                                                    <button class="action-btn delete" onclick="deletePlan('${p.id}', '${p.name.replace(/'/g,"\\'")}')"><i class="fas fa-trash"></i></button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `;
                            }
                        }
                        html += '</div></div>';
                        content.innerHTML = html;
                        break;
                    }
                    case 'invoices': {
                        const r = await fetch('/api/admin-invoices?limit=50', { headers: { 'Authorization': 'Bearer ' + token } });
                        const d = await r.json();
                        content.innerHTML = `
                            <div class="card">
                                <div class="card-header"><h3 class="card-title"><i class="fas fa-file-invoice-dollar"></i> All Invoices (${d.invoices?.length||0})</h3></div>
                                <div class="card-body">
                                    <table class="table"><thead><tr><th>Invoice #</th><th>Customer</th><th>Amount</th><th>Status</th><th>Due Date</th><th>Actions</th></tr></thead>
                                    <tbody>${(d.invoices||[]).map(inv=>`<tr><td><strong>${inv.invoice_number||'N/A'}</strong></td><td>${inv.customers?.company_name||inv.customers?.users?.first_name||'N/A'}</td><td><strong>KES ${parseFloat(inv.total||0).toLocaleString()}</strong></td><td><span class="status-badge status-${inv.status||'draft'}">${inv.status||'draft'}</span></td><td>${inv.due_date?new Date(inv.due_date).toLocaleDateString():'N/A'}</td><td><button class="action-btn" onclick='generateInvoicePDF(${JSON.stringify(inv).replace(/'/g, "&#39;")})' title="Download PDF"><i class="fas fa-file-pdf"></i></button></td></tr>`).join('') || '<tr><td colspan="6" style="text-align:center;color:#999;padding:40px;">No invoices yet</td></tr>'}</tbody></table>
                                </div>
                            </div>
                        `;
                        break;
                    }
                    case 'customers': {
                        const r = await fetch('/api/admin-customers', { headers: { 'Authorization': 'Bearer ' + token } });
                        const d = await r.json();
                        content.innerHTML = `
                            <div class="card">
                                <div class="card-header"><h3 class="card-title"><i class="fas fa-users"></i> All Customers (${d.customers?.length||0})</h3></div>
                                <div class="card-body">
                                    <table class="table"><thead><tr><th>Name</th><th>Company</th><th>Email</th><th>Joined Date</th></tr></thead>
                                    <tbody>${(d.customers||[]).map(c=>`<tr><td><strong>${c.users?.first_name||''} ${c.users?.last_name||''}</strong></td><td>${c.company_name||'<span style="color:#999">-</span>'}</td><td>${c.users?.email||'-'}</td><td>${new Date(c.created_at).toLocaleDateString()}</td></tr>`).join('') || '<tr><td colspan="4" style="text-align:center;color:#999;padding:40px;">No customers yet</td></tr>'}</tbody></table>
                                </div>
                            </div>
                        `;
                        break;
                    }
                    case 'reports': {
                        const r = await fetch('/api/admin-reports', { headers: { 'Authorization': 'Bearer ' + token } });
                        const d = await r.json();
                        content.innerHTML = `
                            <div class="stats-grid">
                                <div class="stat-card"><div class="stat-icon blue"><i class="fas fa-dollar-sign"></i></div><div class="stat-value">KES ${(d.totalRevenue||0).toLocaleString()}</div><div class="stat-label">Total Revenue Earned</div></div>
                                <div class="stat-card"><div class="stat-icon yellow"><i class="fas fa-clock"></i></div><div class="stat-value">KES ${(d.pendingAmount||0).toLocaleString()}</div><div class="stat-label">Pending Collection</div></div>
                            </div>
                            <div class="card">
                                <div class="card-header"><h3 class="card-title"><i class="fas fa-chart-bar"></i> Invoice Summary</h3></div>
                                <div class="card-body">
                                    <table class="table"><thead><tr><th>Status</th><th>Count</th></tr></thead>
                                    <tbody>
                                        <tr><td><span class="status-badge status-draft">Draft</span></td><td><strong>${d.invoiceStats?.draft||0}</strong></td></tr>
                                        <tr><td><span class="status-badge status-sent">Sent</span></td><td><strong>${d.invoiceStats?.sent||0}</strong></td></tr>
                                        <tr><td><span class="status-badge status-paid">Paid</span></td><td><strong>${d.invoiceStats?.paid||0}</strong></td></tr>
                                        <tr><td><span class="status-badge status-overdue">Overdue</span></td><td><strong>${d.invoiceStats?.overdue||0}</strong></td></tr>
                                    </tbody></table>
                                </div>
                            </div>
                        `;
                        break;
                    }
                }
            } catch(e) {
                content.innerHTML = '<div class="card"><div class="card-body"><p style="color:#e74c3c;">Error: ' + e.message + '</p></div></div>';
            }
        }

        async function showAddPlanModal() {
            const sRes = await fetch('/api/admin-services', { headers: { 'Authorization': 'Bearer ' + token } });
            const sData = await sRes.json();
            const services = sData.services || [];
            
            const modal = document.getElementById('modalContainer');
            modal.innerHTML = `
                <div class="modal-overlay active" id="planModal">
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">Add New Pricing Plan</h3>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="planForm">
                                <div class="form-group">
                                    <label>Service Category</label>
                                    <select id="planService" required>${services.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}</select>
                                </div>
                                <div class="form-group">
                                    <label>Plan Name</label>
                                    <input type="text" id="planName" placeholder="e.g., Basic, Professional, Enterprise" required>
                                </div>
                                <div class="form-group">
                                    <label>Description</label>
                                    <textarea id="planDesc" rows="2" placeholder="Brief description"></textarea>
                                </div>
                                <div class="row">
                                    <div class="col">
                                        <div class="form-group">
                                            <label>Price (KES)</label>
                                            <input type="number" id="planPrice" placeholder="0" min="0" required>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="form-group">
                                            <label>Billing Cycle</label>
                                            <select id="planBilling">
                                                <option value="one_time">One Time</option>
                                                <option value="monthly">Monthly</option>
                                                <option value="quarterly">Quarterly</option>
                                                <option value="yearly">Yearly</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="savePlan()"><i class="fas fa-save"></i> Save Plan</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function editPlan(id, name, desc, price, billing, serviceId) {
            const sRes = await fetch('/api/admin-services', { headers: { 'Authorization': 'Bearer ' + token } });
            const sData = await sRes.json();
            const services = sData.services || [];
            
            const modal = document.getElementById('modalContainer');
            modal.innerHTML = `
                <div class="modal-overlay active" id="planModal">
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">Edit Pricing Plan</h3>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="planForm">
                                <input type="hidden" id="editPlanId" value="${id}">
                                <div class="form-group">
                                    <label>Service Category</label>
                                    <select id="planService" required>${services.map(s => `<option value="${s.id}" ${s.id === serviceId ? 'selected' : ''}>${s.name}</option>`).join('')}</select>
                                </div>
                                <div class="form-group">
                                    <label>Plan Name</label>
                                    <input type="text" id="planName" value="${name}" required>
                                </div>
                                <div class="form-group">
                                    <label>Description</label>
                                    <textarea id="planDesc" rows="2">${desc}</textarea>
                                </div>
                                <div class="row">
                                    <div class="col">
                                        <div class="form-group">
                                            <label>Price (KES)</label>
                                            <input type="number" id="planPrice" value="${price}" min="0" required>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="form-group">
                                            <label>Billing Cycle</label>
                                            <select id="planBilling">
                                                <option value="one_time" ${billing==='one_time'?'selected':''}>One Time</option>
                                                <option value="monthly" ${billing==='monthly'?'selected':''}>Monthly</option>
                                                <option value="quarterly" ${billing==='quarterly'?'selected':''}>Quarterly</option>
                                                <option value="yearly" ${billing==='yearly'?'selected':''}>Yearly</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="updatePlan()"><i class="fas fa-save"></i> Update Plan</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function closeModal() {
            document.getElementById('modalContainer').innerHTML = '';
        }

        async function savePlan() {
            const serviceId = document.getElementById('planService').value;
            const name = document.getElementById('planName').value;
            const description = document.getElementById('planDesc').value;
            const price = document.getElementById('planPrice').value;
            const billing_cycle = document.getElementById('planBilling').value;

            if (!name || !price) { showToast('Please fill required fields', 'error'); return; }

            try {
                const res = await fetch('/api/admin-plans', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ service_id: serviceId, name, description, price, billing_cycle })
                });
                const data = await res.json();
                if (res.ok) {
                    closeModal();
                    showToast('Plan added successfully!');
                    showPage('pricing');
                } else {
                    showToast(data.error || 'Failed to save', 'error');
                }
            } catch(e) {
                showToast(e.message, 'error');
            }
        }

        async function updatePlan() {
            const id = document.getElementById('editPlanId').value;
            const serviceId = document.getElementById('planService').value;
            const name = document.getElementById('planName').value;
            const description = document.getElementById('planDesc').value;
            const price = document.getElementById('planPrice').value;
            const billing_cycle = document.getElementById('planBilling').value;

            if (!name || !price) { showToast('Please fill required fields', 'error'); return; }

            try {
                const res = await fetch('/api/admin-plans/' + id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ service_id: serviceId, name, description, price, billing_cycle })
                });
                const data = await res.json();
                if (res.ok) {
                    closeModal();
                    showToast('Plan updated successfully!');
                    showPage('pricing');
                } else {
                    showToast(data.error || 'Failed to update', 'error');
                }
            } catch(e) {
                showToast(e.message, 'error');
            }
        }

        function deletePlan(id, name) {
            if (!confirm(`Delete pricing plan "${name}"?\n\nThis cannot be undone.`)) return;
            fetch('/api/admin-plans/' + id, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            }).then(res => res.json()).then(data => {
                if (data.deleted) {
                    showToast('Plan deleted');
                    showPage('pricing');
                } else {
                    showToast(data.error || 'Failed to delete', 'error');
                }
            }).catch(e => showToast(e.message, 'error'));
        }

        init();
    </script>
</body>
</html>
